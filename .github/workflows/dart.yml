name: Multi-Platform CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  # ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
  analysis_and_tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      # Ù†Ø³ØªØ®Ø¯Ù… ubuntu Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Flutter ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.x.x' # Ø«Ø¨Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ù‡Ù†Ø§
        channel: 'stable'

    - name: Get Dependencies
      run: flutter pub get
      
    - name: Analyze Code
      run: flutter analyze
      
    - name: Run Tests
      # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù‡Ùˆ Ø®Ø·ÙˆØ© Ù…Ø³ØªÙ‚Ù„Ø© Ø¹Ù† Ø§Ù„Ù…Ù†ØµØ©
      run: flutter test

  # ÙˆØ¸ÙŠÙØ© Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„ÙƒÙ„ Ù…Ù†ØµØ© (Build Job)
  build_platform:
    # Ù‡Ø°Ø§ Ø¬Ø²Ø¡ Ø§Ù„Ù…ØµÙÙˆÙØ© (Matrix) Ø§Ù„Ø°ÙŠ ÙŠØ³Ù…Ø­ Ø¨ØªØ´ØºÙŠÙ„ Ù†ÙØ³ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø¹Ù„Ù‰ Ø£Ù†Ø¸Ù…Ø© ØªØ´ØºÙŠÙ„ Ù…Ø®ØªÙ„ÙØ©
    runs-on: ${{ matrix.os }}
    needs: analysis_and_tests # ÙŠØªØ·Ù„Ø¨ Ù†Ø¬Ø§Ø­ ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹
    
    strategy:
      fail-fast: false
      matrix:
        # ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ù†ØµØ§Øª ÙˆØ£Ù†Ø¸Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙŠ Ø³ØªÙ†ÙØ° Ø¹Ù„ÙŠÙ‡Ø§ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨Ù†Ø§Ø¡
        os: [ubuntu-latest, windows-latest, macos-latest]
        platform: [android, windows, ios, web]
        # ØªØµÙÙŠØ© Ø¨Ø¹Ø¶ Ø§Ù„ØªØ±ÙƒÙŠØ¨Ø§Øª ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© (Ù…Ø«Ù„ Ø¨Ù†Ø§Ø¡ iOS Ø¹Ù„Ù‰ Windows Ø£Ùˆ Linux)
        exclude:
          - os: ubuntu-latest
            platform: ios
          - os: windows-latest
            platform: ios
            
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.x.x' # Ø«Ø¨Øª Ù†ÙØ³ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ù‡Ù†Ø§
        channel: 'stable'

    # ----------------------------------------------------
    # Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø®ØµØµØ© Ù„ÙƒÙ„ Ù…Ù†ØµØ©
    # ----------------------------------------------------

    - name: ğŸ“± Build Android (APK)
      if: matrix.platform == 'android'
      run: flutter build apk --release
      
    - name: ğŸ’» Build Windows (EXE)
      if: matrix.platform == 'windows'
      run: flutter build windows --release

    - name: ğŸ–¥ï¸ Build macOS (App Bundle)
      if: matrix.platform == 'ios' || matrix.platform == 'macos'
      # Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ù†Ø§Ø¡ iOS ÙŠØªØ·Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ (Signing Keys) Ø¨Ø´ÙƒÙ„ Ù…Ø¹Ù‚Ø¯
      run: flutter build macos --release

    - name: ğŸŒ Build Web
      if: matrix.platform == 'web'
      run: flutter build web --release

    # ----------------------------------------------------
    # Ø®Ø·ÙˆØ© Ø­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø§ØªØ¬Ø© (Artifacts)
    # ----------------------------------------------------
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}-build-${{ github.sha }}
        # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØµØ©
        path: |
          ${{ matrix.platform == 'android' && 'build/app/outputs/flutter-apk/app-release.apk' || '' }}
          ${{ matrix.platform == 'windows' && 'build/windows/runner/Release' || '' }}
          ${{ matrix.platform == 'macos' && 'build/macos/Build/Products/Release' || '' }}
          ${{ matrix.platform == 'web' && 'build/web' || '' }}
