name: Multi-Platform CI (Mobile & Desktop)

on:
  # ุชุดุบูู ุนูุฏ ุงูุฏูุน ุฃู ูุชุญ ุทูุจุงุช ุงูุฏูุฌ ูููุฑุนูู ุงูุฑุฆูุณููู
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

# ุชุนุฑูู ูุชุบูุฑ ุซุงุจุช ูุฅุตุฏุงุฑ Flutter ุงููุณุชุฎุฏู
env:
  FLUTTER_VERSION: '3.22.0' # <<-- ูุฌุจ ุงุณุชุจุฏุงู ูุฐุง ุจุงูุฅุตุฏุงุฑ ุงูุฏููู ุงูุฐู ูุฏูู

jobs:
  # ----------------------------------------------------
  # 1. ูุธููุฉ ุงูุชุญูู ูู ุงูููุฏ ูุงูุงุฎุชุจุงุฑุงุช (ูุฑุฉ ูุงุญุฏุฉ ููุท)
  # ----------------------------------------------------
  analysis_and_tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Setup Flutter SDK
      # ุฅุนุฏุงุฏ Flutter ุจุงุณุชุฎุฏุงู ุงูุฅุตุฏุงุฑ ุงููุญุฏุฏ ูู env
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Get Dependencies
      run: flutter pub get
      
    - name: Analyze Code
      run: flutter analyze
      
    - name: Run Unit and Widget Tests
      run: flutter test

  # ----------------------------------------------------
  # 2. ูุธููุฉ ุจูุงุก ุงูุชุทุจูู ููู ููุตุฉ (ุจุงุณุชุฎุฏุงู Matrix)
  # ----------------------------------------------------
  build_platform:
    runs-on: ${{ matrix.os }}
    needs: analysis_and_tests # ูุจุฏุฃ ููุท ุจุนุฏ ูุฌุงุญ ุงูุงุฎุชุจุงุฑุงุช ูุงูุชุญููู
    
    strategy:
      fail-fast: false
      matrix:
        # ุชุนุฑูู ุฃูุธูุฉ ุงูุชุดุบูู ูุงูููุตุงุช ุงููุฑุงุฏ ุจูุงุกูุง
        os: [ubuntu-latest, windows-latest, macos-latest]
        platform: [android, windows, ios, web]
        
        # ุงุณุชุซูุงุก ุงูุชุฑููุจุงุช ุบูุฑ ุงูุถุฑูุฑูุฉ/ุงููุชุนุงุฑุถุฉ:
        exclude:
          - os: ubuntu-latest
            platform: ios # ูุง ูููู ุจูุงุก iOS ุนูู Linux
          - os: windows-latest
            platform: ios # ูุง ูููู ุจูุงุก iOS ุนูู Windows
            
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Get Dependencies
      run: flutter pub get

    # --- ุฎุทูุงุช ุงูุจูุงุก ---

    - name: ๐ฑ Build Android (APK)
      if: matrix.platform == 'android'
      run: flutter build apk --release
      
    - name: ๐ป Build Windows (EXE)
      if: matrix.platform == 'windows'
      run: flutter build windows --release

    - name: ๐ฅ๏ธ Build Linux (App Bundle)
      if: matrix.platform == 'linux'
      run: flutter build linux --release

    - name: ๐ Build iOS/macOS (App Bundle)
      # ุณูุนูู ูุฐุง ุงูุดุฑุท ููุท ุนูู macOS
      if: matrix.platform == 'ios' || matrix.platform == 'macos'
      run: flutter build ios --no-codesign # ุฃู flutter build macos --release
      
    - name: ๐ Build Web
      if: matrix.platform == 'web'
      run: flutter build web --release

    # --- ุฎุทูุฉ ุญูุธ ุงููููุงุช ุงููุงุชุฌุฉ (Artifacts) ---
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}-build-${{ github.sha }}
        # ุชุญุฏูุฏ ุงููุณุงุฑ ุงูุตุญูุญ ููููู ุงูุฐู ุชู ุจูุงุคู
        path: |
          ${{ matrix.platform == 'android' && 'build/app/outputs/flutter-apk/app-release.apk' || '' }}
          ${{ matrix.platform == 'windows' && 'build/windows/runner/Release' || '' }}
          ${{ matrix.platform == 'linux' && 'build/linux/x64/release/bundle' || '' }}
          ${{ matrix.platform == 'ios' && 'build/ios/iphoneos/Runner.app' || '' }}
          ${{ matrix.platform == 'web' && 'build/web' || '' }}
