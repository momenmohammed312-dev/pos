name: Multi-Platform CI (Mobile & Desktop)

on:
  # ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹ Ø£Ùˆ ÙØªØ­ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯Ù…Ø¬
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

# ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ± Ø«Ø§Ø¨Øª Ù„Ø¥ØµØ¯Ø§Ø± Flutter (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ flutter doctor Ù„Ø¯ÙŠÙƒ)
env:
  FLUTTER_VERSION: '3.35.7' # <--- ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø°ÙŠ Ù„Ø¯ÙŠÙƒ
  
jobs:
  # ----------------------------------------------------
  # 1. ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
  # ----------------------------------------------------
  analysis_and_tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Setup Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Get Dependencies
      run: flutter pub get
      
    - name: Analyze Code
      run: flutter analyze
      
    - name: Run Unit and Widget Tests
      run: flutter test

  # ----------------------------------------------------
  # 2. ÙˆØ¸ÙŠÙØ© Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„ÙƒÙ„ Ù…Ù†ØµØ© (Build Job)
  # ----------------------------------------------------
  build_platform:
    runs-on: ${{ matrix.os }}
    needs: analysis_and_tests 
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest] # Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Android Ùˆ Windows Ùˆ Linux (Ø¹Ù„Ù‰ Ubuntu)
        platform: [android, windows, linux, web]
        
        exclude:
          - os: windows-latest
            platform: linux # Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¨Ù†Ø§Ø¡ Linux Ø¹Ù„Ù‰ Windows
            
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        # ØªØ«Ø¨ÙŠØª ÙˆØªÙƒÙˆÙŠÙ† Ø¨ÙŠØ¦Ø© Visual Studio Ø¹Ù„Ù‰ Windows
        # ØªØ«Ø¨ÙŠØª Ø­Ø²Ù… Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© Ø¹Ù„Ù‰ Linux/Ubuntu
        
    # Ø®Ø·ÙˆØ© Ù…Ù‡Ù…Ø©: ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ù…Ù†ØµØ© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² GitHub Actions
    - name: Enable Desktop Support
      if: matrix.platform == 'windows' || matrix.platform == 'linux'
      run: flutter config --enable-${{ matrix.platform }}-desktop

    - name: Get Dependencies
      run: flutter pub get

    # --- Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ ---

    - name: ğŸ“± Build Android (APK)
      if: matrix.platform == 'android'
      # Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ«Ø¨ÙŠØª Java/SDK Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Gradle
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        cache: 'gradle'
      
    - name: Build Android APK
      if: matrix.platform == 'android'
      run: flutter build apk --release
      
    - name: ğŸ’» Build Windows (EXE)
      if: matrix.platform == 'windows'
      run: flutter build windows --release

    - name: ğŸ–¥ï¸ Build Linux (App Bundle)
      if: matrix.platform == 'linux'
      run: flutter build linux --release
      
    - name: ğŸŒ Build Web
      if: matrix.platform == 'web'
      run: flutter build web --release

    # --- Ø®Ø·ÙˆØ© Ø­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø§ØªØ¬Ø© (Artifacts) ---
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}-build-${{ github.sha }}
        # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ù…Ù„Ù Ø§Ù„Ø°ÙŠ ØªÙ… Ø¨Ù†Ø§Ø¤Ù‡
        path: |
          ${{ matrix.platform == 'android' && 'build/app/outputs/flutter-apk/app-release.apk' || '' }}
          ${{ matrix.platform == 'windows' && 'build/windows/runner/Release' || '' }}
          ${{ matrix.platform == 'linux' && 'build/linux/x64/release/bundle' || '' }}
          ${{ matrix.platform == 'web' && 'build/web' || '' }}
