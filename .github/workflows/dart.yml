name: Multi-Platform CI (Mobile & Desktop)

on:
  # ุงูุชุดุบูู ุนูุฏ ุงูุฏูุน (Push) ุฃู ูุชุญ ุทูุจุงุช ุงูุฏูุฌ (Pull Requests) ูููุฑุนูู ุงูุฑุฆูุณููู
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

# ุชุนุฑูู ูุชุบูุฑ ุซุงุจุช ูุฅุตุฏุงุฑ Flutter ุงููุณุชุฎุฏู ูุชุฌูุจ ุฃุฎุทุงุก ุงูุชุญุฏูุฏ
env:
  FLUTTER_VERSION: '3.22.0' # <<-- ุบููุฑ ูุฐุง ุงูุฑูู ุฅูู ุงูุฅุตุฏุงุฑ ุงูุฐู ุชูููู ุฃู ุชุฑูุฏู

jobs:
  # ----------------------------------------------------
  # 1. ูุธููุฉ ุงูุชุญูู ูู ุงูููุฏ ูุงูุงุฎุชุจุงุฑุงุช (Analysis & Tests)
  # ุงููุฏู: ุงูุชุฃูุฏ ูู ุณูุงูุฉ ุงูููุฏ ูุจู ูุญุงููุฉ ุงูุจูุงุก
  # ----------------------------------------------------
  analysis_and_tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Setup Flutter SDK
      # ููุง ูุชู ุชุญุฏูุฏ ุงูุฅุตุฏุงุฑ ุจุฏูุฉ ุจุงุณุชุฎุฏุงู ูุชุบูุฑ ุงูุจูุฆุฉ ุงูููุนุฑู
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Get Dependencies
      run: flutter pub get
      
    - name: Analyze Code (Fails on Warnings/Errors)
      run: flutter analyze
      
    - name: Run Unit and Widget Tests
      run: flutter test

  # ----------------------------------------------------
  # 2. ูุธููุฉ ุจูุงุก ุงูุชุทุจูู ููู ููุตุฉ (Build Job)
  # ุชุณุชุฎุฏู ุงููุตูููุฉ (Matrix) ูุชุดุบูู ููุณ ุงูุฎุทูุงุช ุนูู ุฃูุธูุฉ ุชุดุบูู ูุฎุชููุฉ
  # ----------------------------------------------------
  build_platform:
    runs-on: ${{ matrix.os }}
    needs: analysis_and_tests # ูุจุฏุฃ ููุท ุฅุฐุง ูุฌุญุช ูุธููุฉ ุงูุงุฎุชุจุงุฑุงุช
    
    strategy:
      fail-fast: false
      matrix:
        # ุชุญุฏูุฏ ุฃูุธูุฉ ุงูุชุดุบูู (OS) ูุงูููุตุงุช (Platform) ุงููุฑุงุฏ ุจูุงุกูุง
        os: [ubuntu-latest, windows-latest, macos-latest]
        platform: [android, windows, linux, web] # ุงุณุชุจุนุงุฏ iOS ููุง ูุชุฌูุจ ุงูุชุนููุฏ ุจุฎุตูุต ุงูุชูููุน
        
        # ุงุณุชุซูุงุก ุงูุชุฑููุจุงุช ุบูุฑ ุงูุถุฑูุฑูุฉ:
        exclude:
          - os: windows-latest
            platform: linux # ูุง ูููู ุจูุงุก Linux ุนูู Windows
          - os: macos-latest
            platform: linux # ูุฑูุฒ ุนูู ุงูููุตุงุช ุงูุฃุณุงุณูุฉ ูู macOS

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Get Dependencies
      run: flutter pub get

    # --- ุฎุทูุงุช ุงูุจูุงุก ---

    - name: ๐ฑ Build Android (APK)
      if: matrix.platform == 'android'
      run: flutter build apk --release
      
    - name: ๐ป Build Windows (EXE)
      if: matrix.platform == 'windows'
      run: flutter build windows --release

    - name: ๐ฅ๏ธ Build Linux (App Bundle)
      if: matrix.platform == 'linux'
      run: flutter build linux --release
      
    - name: ๐ Build Web
      if: matrix.platform == 'web'
      run: flutter build web --release

    # --- ุฎุทูุฉ ุญูุธ ุงููููุงุช ุงููุงุชุฌุฉ (Artifacts) ---
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}-build-${{ github.sha }}
        # ุชุญุฏูุฏ ุงููุณุงุฑ ุงูุตุญูุญ ููููู ุงูุฐู ุชู ุจูุงุคู
        path: |
          ${{ matrix.platform == 'android' && 'build/app/outputs/flutter-apk/app-release.apk' || '' }}
          ${{ matrix.platform == 'windows' && 'build/windows/runner/Release' || '' }}
          ${{ matrix.platform == 'linux' && 'build/linux/x64/release/bundle' || '' }}
          ${{ matrix.platform == 'web' && 'build/web' || '' }}
